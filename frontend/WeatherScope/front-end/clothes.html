<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Clothing Selection ‚Äî WeatherScope</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    .clothing-item {
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      margin: 8px 0;
      cursor: pointer;
      transition: all 0.3s;
    }
    .clothing-item:hover {
      border-color: #0d6efd;
      background-color: #f8f9fa;
    }
    .clothing-item.selected {
      border-color: #0d6efd;
      background-color: #e7f1ff;
    }
    .clothing-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    .temp-group-section {
      margin-bottom: 2rem;
    }
  </style>
</head>
<body>
  <header class="navbar sticky-top bg-dark flex-md-nowrap p-0 shadow" data-bs-theme="dark">
    <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3 fs-6 text-white" href="/static/index.html">WeatherScope</a>
    <nav class="ms-auto px-3">
      <a class="text-white text-decoration-none me-3" href="/static/index.html">Home</a>
      <a class="text-white text-decoration-none me-3" href="/static/clothes.html">My Clothes</a>
      <a class="text-white text-decoration-none" href="#" id="logout-link">Logout</a>
    </nav>
  </header>

  <div class="container mt-4">
    <h1>Select Your Clothing Preferences</h1>
    <p class="text-muted">Choose clothing items you prefer for each temperature range. These will be recommended when you check the weather.</p>

    <div id="loading" class="text-center my-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <div id="content" style="display:none;">
      <div class="temp-group-section">
        <h2 class="text-primary">‚ùÑÔ∏è Cold Weather (Below -10¬∞C)</h2>
        <div id="cold-items" class="row"></div>
      </div>

      <div class="temp-group-section">
        <h2 class="text-info">üçÇ Cool Weather (-10¬∞C to +10¬∞C)</h2>
        <div id="cool-items" class="row"></div>
      </div>

      <div class="temp-group-section">
        <h2 class="text-warning">‚òÄÔ∏è Warm Weather (Above +10¬∞C)</h2>
        <div id="warm-items" class="row"></div>
      </div>

      <div class="text-center my-4">
        <button id="save-btn" class="btn btn-primary btn-lg px-5">Save My Selection</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="auth-utils.js"></script>
  <script>
    const selectedItems = new Set();

    async function loadClothingItems() {
      try {
        const availableResp = await fetch('/api/v1/clothes/available/', { credentials: 'same-origin' });
        if (availableResp.status === 401) {
          window.location.href = '/static/login.html';
          return;
        }
        const available = await availableResp.json();

        const selectionResp = await fetch('/api/v1/clothes/my-selection/', { credentials: 'same-origin' });
        const selection = await selectionResp.json();

        selection.selected_items.forEach(item => selectedItems.add(item.id));

        renderItems('cold', available.cold);
        renderItems('cool', available.cool);
        renderItems('warm', available.warm);

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
      } catch (error) {
        console.error('Error loading clothing items:', error);
        alert('Failed to load clothing items');
      }
    }

    function renderItems(group, items) {
      const container = document.getElementById(`${group}-items`);
      container.innerHTML = '';

      items.forEach(item => {
        const isSelected = selectedItems.has(item.id);
        const div = document.createElement('div');
        div.className = 'col-md-6 col-lg-4';
        div.innerHTML = `
          <div class="clothing-item ${isSelected ? 'selected' : ''}" data-id="${item.id}">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="item-${item.id}" ${isSelected ? 'checked' : ''}>
              <label class="form-check-label w-100" for="item-${item.id}">
                <strong>${item.name}</strong>
                ${item.description ? `<br><small class="text-muted">${item.description}</small>` : ''}
              </label>
            </div>
          </div>
        `;
        container.appendChild(div);

        const clothingDiv = div.querySelector('.clothing-item');
        const checkbox = div.querySelector('input[type="checkbox"]');

        clothingDiv.addEventListener('click', (e) => {
          if (e.target.tagName !== 'INPUT') {
            checkbox.checked = !checkbox.checked;
            toggleSelection(item.id, checkbox.checked, clothingDiv);
          }
        });

        checkbox.addEventListener('change', (e) => {
          toggleSelection(item.id, e.target.checked, clothingDiv);
        });
      });
    }

    function toggleSelection(itemId, isSelected, element) {
      if (isSelected) {
        selectedItems.add(itemId);
        element.classList.add('selected');
      } else {
        selectedItems.delete(itemId);
        element.classList.remove('selected');
      }
    }

    async function saveSelection() {
      const saveBtn = document.getElementById('save-btn');
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

      try {
        const resp = await fetch('/api/v1/clothes/my-selection/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ item_ids: Array.from(selectedItems) })
        });

        if (resp.ok) {
          alert('Your clothing preferences have been saved!');
        } else {
          alert('Failed to save preferences');
        }
      } catch (error) {
        console.error('Error saving selection:', error);
        alert('Failed to save preferences');
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = 'Save My Selection';
      }
    }

    document.getElementById('save-btn').addEventListener('click', saveSelection);

    document.getElementById('logout-link').addEventListener('click', async (e) => {
      e.preventDefault();
      await fetch('/api/v1/logout/', { credentials: 'same-origin' });
      window.location.href = '/static/login.html';
    });

    loadClothingItems();
  </script>
</body>
</html>

